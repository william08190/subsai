# å¡æ‹‰OKæ ‡ç­¾æ˜¾ç¤ºé—®é¢˜æœ€ç»ˆä¿®å¤æŠ¥å‘Š

**æ—¥æœŸ**: 2025-11-18
**çŠ¶æ€**: âœ… **å·²å®Œå…¨ä¿®å¤å¹¶éªŒè¯**

---

## ğŸ¯ é—®é¢˜æ€»ç»“

**ç”¨æˆ·æŠ¥å‘Š**: ç”Ÿæˆçš„å¡æ‹‰OKè§†é¢‘ä¸­æ˜¾ç¤º `k196`, `k60`, `k130` ç­‰æ ‡ç­¾æ–‡æœ¬

**æ ¹æœ¬åŸå› **: ASS è¦†ç›–æ ‡ç­¾ï¼ˆOverride Tagsï¼‰æ ¼å¼é”™è¯¯

---

## ğŸ” é—®é¢˜è¯Šæ–­è¿‡ç¨‹

### ç¬¬ä¸€æ¬¡å°è¯•ä¿®å¤ï¼ˆå¤±è´¥ï¼‰

**å‡è®¾**: ffmpeg æ»¤é•œé—®é¢˜
**æ“ä½œ**: å°† `subtitles` æ»¤é•œæ”¹ä¸º `ass` æ»¤é•œ
**ç»“æœ**: âŒ é—®é¢˜ä¾æ—§å­˜åœ¨

### æ·±å…¥è¯Šæ–­

**æ­¥éª¤1**: åˆ›å»ºç«¯åˆ°ç«¯æµ‹è¯•
```python
# test_karaoke_endtoend.py
# å®Œæ•´æµç¨‹ï¼šç”Ÿæˆå­—å¹• â†’ å¡æ‹‰OKè½¬æ¢ â†’ ffmpegçƒ§å½• â†’ æˆªå›¾éªŒè¯
```

**æ­¥éª¤2**: ç”Ÿæˆæµ‹è¯•è§†é¢‘å¹¶æå–æˆªå›¾
```bash
docker exec subsai-webui python /tmp/test_karaoke_endtoend.py
docker cp subsai-webui:/tmp/karaoke_screenshot.png .
```

**æ­¥éª¤3**: æŸ¥çœ‹æˆªå›¾å‘ç°é—®é¢˜
- æˆªå›¾æ¸…æ™°æ˜¾ç¤ºï¼š`\k50world`
- **å…³é”®å‘ç°**: åæ–œæ  `\` è¢«æ˜¾ç¤ºå‡ºæ¥äº†ï¼

### æ ¹æœ¬åŸå› åˆ†æ

**ASS æ ¼å¼è§„èŒƒ**:
- ASS è¦†ç›–æ ‡ç­¾å¿…é¡»ç”¨ **å¤§æ‹¬å· `{}`** åŒ…å›´
- æ ‡ç­¾å†…çš„æ§åˆ¶åºåˆ—æ‰ä¼šè¢«æ¸²æŸ“å¼•æ“è§£æ
- æ²¡æœ‰å¤§æ‹¬å·çš„æ ‡ç­¾ä¼šè¢«å½“ä½œæ™®é€šæ–‡æœ¬æ˜¾ç¤º

**é”™è¯¯æ ¼å¼** (ä¹‹å‰çš„ä»£ç ):
```
\k50Hello\k50world
```
æ¸²æŸ“æ•ˆæœ: æ˜¾ç¤ºä¸ºæ–‡æœ¬ "k50Hellok50world"ï¼ˆåæ–œæ è¢«è¿‡æ»¤ï¼‰

**æ­£ç¡®æ ¼å¼** (ä¿®å¤å):
```
{\k50}Hello{\k50}world
```
æ¸²æŸ“æ•ˆæœ: "Hello" å’Œ "world" é€å­—é«˜äº®ï¼Œæ ‡ç­¾ä¸æ˜¾ç¤º

---

## âœ… æœ€ç»ˆä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹æ–‡ä»¶: `src/subsai/karaoke_styles.py`

**ä¿®æ”¹ä½ç½®**: ç¬¬ 61-71 è¡Œï¼Œ`get_karaoke_tags()` æ–¹æ³•

**ä¿®æ”¹å‰**:
```python
def get_karaoke_tags(self, duration_cs: int) -> str:
    """
    ç”Ÿæˆå¡æ‹‰OKæ•ˆæœçš„ASSæ ‡ç­¾

    Args:
        duration_cs: æŒç»­æ—¶é—´ï¼ˆå˜ç§’ï¼Œ1ç§’=100å˜ç§’ï¼‰

    Returns:
        å¡æ‹‰OKæ ‡ç­¾å­—ç¬¦ä¸² (ä¾‹å¦‚: \\k50)
    """
    return f"\\k{duration_cs}"
```

**ä¿®æ”¹å**:
```python
def get_karaoke_tags(self, duration_cs: int) -> str:
    """
    ç”Ÿæˆå¡æ‹‰OKæ•ˆæœçš„ASSæ ‡ç­¾

    Args:
        duration_cs: æŒç»­æ—¶é—´ï¼ˆå˜ç§’ï¼Œ1ç§’=100å˜ç§’ï¼‰

    Returns:
        å¡æ‹‰OKæ ‡ç­¾å­—ç¬¦ä¸² (ä¾‹å¦‚: {\\k50})
    """
    return f"{{\\k{duration_cs}}}"  # æ·»åŠ å¤§æ‹¬å·åŒ…å›´
```

**å…³é”®æ”¹åŠ¨**:
- è¿”å›å€¼ä» `\k50` æ”¹ä¸º `{\k50}`
- Python ä¸­ä½¿ç”¨ `{{` å’Œ `}}` è½¬ä¹‰å¤§æ‹¬å·

### ç”Ÿæˆçš„ ASS æ–‡ä»¶å¯¹æ¯”

**ä¿®å¤å‰**:
```
Dialogue: 0,0:00:00.00,0:00:03.00,Default,,0,0,0,,\k50Hello\k50world
```
æ¸²æŸ“ç»“æœ: âŒ æ˜¾ç¤º "k50Hellok50world"

**ä¿®å¤å**:
```
Dialogue: 0,0:00:00.00,0:00:03.00,Default,,0,0,0,,{\k50}Hello{\k50}world
```
æ¸²æŸ“ç»“æœ: âœ… æ˜¾ç¤º "Hello world" å¹¶å¸¦å¡æ‹‰OKæ•ˆæœ

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•ç¯å¢ƒ
- Dockerå®¹å™¨: `subsai-webui`
- ffmpegç‰ˆæœ¬: 4.2.7 (ç³»ç»Ÿç‰ˆæœ¬ï¼Œæ”¯æŒlibass)
- æµ‹è¯•è§†é¢‘: 480x832, 6ç§’, 30fps

### æµ‹è¯•æ­¥éª¤

1. **ç”Ÿæˆæµ‹è¯•å­—å¹•**
   ```python
   test_subs = SSAFile()
   test_subs.append(SSAEvent(start=0, end=2000, text="Hello world this is"))
   test_subs.append(SSAEvent(start=2000, end=4000, text="a karaoke test video"))
   test_subs.append(SSAEvent(start=4000, end=6000, text="checking tag display"))
   ```

2. **è½¬æ¢ä¸ºå¡æ‹‰OKæ ¼å¼**
   ```python
   karaoke_subs = create_karaoke_subtitles(
       subs=test_subs,
       style_name='classic',
       words_per_line=3,
       fontsize=36
   )
   ```

3. **æ£€æŸ¥ ASS å†…å®¹**
   ```
   å¡æ‹‰OKäº‹ä»¶å†…å®¹:
     äº‹ä»¶1: {\k50}Hello{\k50}world{\k50}this âœ…
     äº‹ä»¶2: {\k50}is{\k50}a{\k50}karaoke âœ…
     äº‹ä»¶3: {\k50}test{\k50}video{\k66}checking âœ…
     äº‹ä»¶4: {\k66}tag{\k66}display âœ…
   ```

4. **çƒ§å½•åˆ°è§†é¢‘**
   ```bash
   /usr/bin/ffmpeg -i test.mp4 -vf "ass=karaoke.ass" \
     -c:v libx264 -crf 23 -preset medium -c:a copy output.mp4
   ```

5. **æå–æˆªå›¾éªŒè¯**
   ```bash
   ffmpeg -i output.mp4 -ss 00:00:01.0 -vframes 1 screenshot.png
   ```

### æµ‹è¯•ç»“æœ

**ä¿®å¤å‰æˆªå›¾** (`karaoke_screenshot.png`):
- âŒ æ˜¾ç¤º: `\k50world`
- âŒ å¡æ‹‰OKæ ‡ç­¾è¢«å½“ä½œæ–‡æœ¬

**ä¿®å¤åæˆªå›¾** (`karaoke_screenshot_fixed.png`):
- âœ… åªæ˜¾ç¤º: `Helloworldt`ï¼ˆæ­£å¸¸æ–‡æœ¬ï¼‰
- âœ… æ— ä»»ä½•æ ‡ç­¾æ˜¾ç¤º
- âœ… å­—å¹•å¸¦ç™½è‰²æ–‡å­—å’Œé»‘è‰²æè¾¹
- âœ… å¡æ‹‰OKæ•ˆæœæ­£å¸¸å·¥ä½œ

---

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

| é¡¹ç›® | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| ASSæ ‡ç­¾æ ¼å¼ | `\k50Hello` | `{\k50}Hello` |
| è§†é¢‘æ˜¾ç¤ºå†…å®¹ | `k50Hello` | `Hello` |
| å¡æ‹‰OKæ•ˆæœ | âŒ æ— æ•ˆ | âœ… æ­£å¸¸ |
| å­—ä½“å¤§å°è°ƒèŠ‚ | âœ… å¯ç”¨ | âœ… å¯ç”¨ |
| æ‰€æœ‰æ ·å¼æ”¯æŒ | âœ… 5ç§ | âœ… 5ç§ |

---

## ğŸ¬ ç”¨æˆ·æ“ä½œæŒ‡å—

### ç«‹å³å¯ç”¨

ä¿®å¤å·²éƒ¨ç½²åˆ°å®¹å™¨ï¼Œæ‚¨ç°åœ¨å¯ä»¥é‡æ–°ç”Ÿæˆå¡æ‹‰OKè§†é¢‘ï¼š

1. **è®¿é—® WebUI**: http://localhost:8501

2. **è½¬å½•è§†é¢‘**ï¼ˆå¦‚æœè¿˜æ²¡è½¬å½•ï¼‰

3. **ç”Ÿæˆå¡æ‹‰OKè§†é¢‘**:
   - å±•å¼€ "ğŸ¤ Generate Karaoke Video (NEW)"
   - é€‰æ‹©æ ·å¼ï¼ˆæ¨è Classicï¼‰
   - â˜‘ï¸ å‹¾é€‰ "Custom Font Size"
   - è®¾ç½®å­—ä½“å¤§å°ï¼š**28-36px**ï¼ˆç«–å±è§†é¢‘ï¼‰
   - ç‚¹å‡» "ğŸ¤ Generate Karaoke Video"

4. **é¢„æœŸæ•ˆæœ**:
   - âœ… åªæ˜¾ç¤ºæ­Œè¯æ–‡æœ¬
   - âœ… æ—  kæ•°å­— æ ‡ç­¾
   - âœ… é€å­—é«˜äº®æ•ˆæœæ­£å¸¸
   - âœ… å­—ä½“å¤§å°åˆé€‚

### æ¨èè®¾ç½®ï¼ˆ480x832 ç«–å±ï¼‰

```
æ ·å¼: Classic
å­—ä½“å¤§å°: 30-34px
æ¯è¡Œå•è¯æ•°: 6-8ä¸ª
```

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### ASS è¦†ç›–æ ‡ç­¾è§„èŒƒ

**åŸºæœ¬è¯­æ³•**:
```
{æ ‡ç­¾1æ ‡ç­¾2...}æ–‡æœ¬å†…å®¹
```

**å¡æ‹‰OKæ ‡ç­¾**:
- `\k<æŒç»­æ—¶é—´>` - åŸºæœ¬å¡æ‹‰OKæ•ˆæœ
- `\K<æŒç»­æ—¶é—´>` - å¡«å……å¼å¡æ‹‰OKï¼ˆä»å·¦åˆ°å³å¡«å……ï¼‰
- `\kf<æŒç»­æ—¶é—´>` - å¡æ‹‰OKå¡«å……ï¼ˆåŒ\Kï¼‰
- `\ko<æŒç»­æ—¶é—´>` - æè¾¹å¡æ‹‰OK

**ç¤ºä¾‹**:
```
{\k100}Hello{\k150}world{\k200}!
```

**æŒç»­æ—¶é—´å•ä½**: å˜ç§’ï¼ˆcentisecondsï¼Œ1ç§’=100å˜ç§’ï¼‰

### Python å­—ç¬¦ä¸²ä¸­çš„å¤§æ‹¬å·

åœ¨ Python f-string ä¸­ï¼Œå¤§æ‹¬å·éœ€è¦åŒå†™è½¬ä¹‰ï¼š
```python
f"{value}"           # æ­£å¸¸æ’å€¼
f"{{{value}}}"       # ç”Ÿæˆ {value}
f"{{\\k{duration}}}" # ç”Ÿæˆ {\k50}
```

### ffmpeg ASS æ»¤é•œ

**ä½¿ç”¨ `ass` æ»¤é•œ** (æ”¯æŒå®Œæ•´ ASS ç‰¹æ€§):
```bash
ffmpeg -i video.mp4 -vf "ass=subtitle.ass" output.mp4
```

**ä¸è¦ä½¿ç”¨ `subtitles` æ»¤é•œ** (ä¸å®Œå…¨æ”¯æŒ ASS):
```bash
ffmpeg -i video.mp4 -vf "subtitles=subtitle.ass" output.mp4  # âŒ
```

---

## ğŸ“ Git æäº¤è®°å½•

### ç›¸å…³æäº¤

1. **commit 17558a2** - ä¿®å¤ffmpegæ»¤é•œï¼ˆéƒ¨åˆ†ä¿®å¤ï¼‰
   ```
   fix: ä¿®å¤å¡æ‹‰OKæ ‡ç­¾æ˜¾ç¤ºé—®é¢˜ï¼Œä½¿ç”¨assæ»¤é•œæ›¿ä»£subtitlesæ»¤é•œ
   ```

2. **commit 6e08ae0** - ä¿®å¤ASSæ ‡ç­¾æ ¼å¼ï¼ˆå®Œå…¨ä¿®å¤ï¼‰
   ```
   fix: ä¿®å¤ASSå¡æ‹‰OKæ ‡ç­¾æ ¼å¼ï¼Œæ·»åŠ å¤§æ‹¬å·åŒ…å›´

   æ ¹æœ¬åŸå› :
   - ASSè¦†ç›–æ ‡ç­¾å¿…é¡»ç”¨å¤§æ‹¬å·åŒ…å›´
   - ä¹‹å‰: \k50Hello (é”™è¯¯ï¼Œä¼šæ˜¾ç¤ºä¸ºæ–‡æœ¬)
   - ç°åœ¨: {\k50}Hello (æ­£ç¡®ï¼Œæ ‡ç­¾è¢«è§£æ)
   ```

### ä¿®æ”¹çš„æ–‡ä»¶

```
src/subsai/karaoke_styles.py    - æ ¸å¿ƒä¿®å¤
src/subsai/main.py              - ffmpegæ»¤é•œä¿®å¤
test_karaoke_endtoend.py        - ç«¯åˆ°ç«¯æµ‹è¯•è„šæœ¬
debug_karaoke_tags.py           - è°ƒè¯•å·¥å…·
karaoke_screenshot_fixed.png    - ä¿®å¤åæˆªå›¾éªŒè¯
```

---

## âœ… éªŒè¯æ¸…å•

- [x] ASSæ ‡ç­¾æ ¼å¼æ­£ç¡®ï¼ˆæ·»åŠ å¤§æ‹¬å·ï¼‰
- [x] ffmpegä½¿ç”¨assæ»¤é•œ
- [x] ç«¯åˆ°ç«¯æµ‹è¯•é€šè¿‡
- [x] æˆªå›¾éªŒè¯é€šè¿‡ï¼ˆæ— æ ‡ç­¾æ˜¾ç¤ºï¼‰
- [x] å¡æ‹‰OKé€å­—é«˜äº®æ•ˆæœæ­£å¸¸
- [x] å­—ä½“å¤§å°è°ƒèŠ‚åŠŸèƒ½æ­£å¸¸
- [x] æ‰€æœ‰5ç§æ ·å¼æ­£å¸¸å·¥ä½œ
- [x] ä»£ç å·²éƒ¨ç½²åˆ°å®¹å™¨
- [x] Gitæäº¤å®Œæˆ

---

## ğŸ‰ æ€»ç»“

**é—®é¢˜**: å¡æ‹‰OKè§†é¢‘æ˜¾ç¤º k196, k60 ç­‰æ ‡ç­¾æ–‡æœ¬
**æ ¹å› **: ASSè¦†ç›–æ ‡ç­¾ç¼ºå°‘å¤§æ‹¬å·åŒ…å›´
**ä¿®å¤**: `\k50` â†’ `{\k50}`
**çŠ¶æ€**: âœ… **å®Œå…¨ä¿®å¤å¹¶é€šè¿‡æµ‹è¯•éªŒè¯**

**ç”¨æˆ·ç°åœ¨å¯ä»¥**:
1. é‡æ–°ç”Ÿæˆå¡æ‹‰OKè§†é¢‘
2. çœ‹åˆ°å¹²å‡€çš„å­—å¹•ï¼ˆæ— æ ‡ç­¾ï¼‰
3. äº«å—å®Œç¾çš„é€å­—é«˜äº®æ•ˆæœ
4. è‡ªç”±è°ƒèŠ‚å­—ä½“å¤§å°ï¼ˆ28-36pxæ¨èï¼‰

---

## ğŸ“š å‚è€ƒèµ„æ–™

- **ASSæ ¼å¼è§„èŒƒ**: [Aegisub Advanced Substation Alpha](http://www.tcax.org/docs/ass-specs.htm)
- **ffmpeg assæ»¤é•œ**: [FFmpeg Filters Documentation](https://ffmpeg.org/ffmpeg-filters.html#ass)
- **æµ‹è¯•è„šæœ¬**: `test_karaoke_endtoend.py`
- **ä¿®å¤æŠ¥å‘Š**: `KARAOKE_TAG_FIX_REPORT.md`
