# å¡æ‹‰OKå­—å¹•çƒ§å½•åŠŸèƒ½æµ‹è¯•æŠ¥å‘Š

## æµ‹è¯•æ—¥æœŸ
2025-11-18

## æµ‹è¯•ç›®æ ‡
éªŒè¯SubsAIå¡æ‹‰OKå­—å¹•ç”Ÿæˆå’Œè§†é¢‘çƒ§å½•åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ

## é—®é¢˜æè¿°
ç”¨æˆ·æŠ¥å‘Š"Generate Karaoke Video"åŠŸèƒ½ç”Ÿæˆçš„è§†é¢‘æ²¡æœ‰å­—å¹•æ˜¾ç¤º

## æ ¹æœ¬åŸå› åˆ†æ

### 1. Pythonç¼“å­˜é—®é¢˜
- **é—®é¢˜**: å®¹å™¨ä¸­çš„æ—§Pythonå­—èŠ‚ç ç¼“å­˜å¯¼è‡´ä»£ç æ›´æ–°ä¸ç”Ÿæ•ˆ
- **è¡¨ç°**: `karaoke_subs.styles['Default']` è¿”å›å­—ç¬¦ä¸²è€Œé`SSAStyle`å¯¹è±¡
- **è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨`--no-cache`å®Œå…¨é‡å»ºDockeré•œåƒ

### 2. ffmpegç¯å¢ƒé—®é¢˜
- **é—®é¢˜**: Condaç¯å¢ƒçš„ffmpegç¼ºå°‘å¿…è¦çš„ç¼–ç å™¨å’Œæ»¤é•œ
  - Conda ffmpeg (4.3): ä»…æ”¯æŒ`libopenh264`ï¼Œç¼ºå°‘`libx264`å’Œ`subtitles`æ»¤é•œ
  - ç³»ç»Ÿffmpeg (4.2.7): å®Œæ•´æ”¯æŒ`libx264`å’Œ`libass (subtitlesæ»¤é•œ)`
- **PATHä¼˜å…ˆçº§**: Condaçš„ffmpeg (`/opt/conda/bin/ffmpeg`) åœ¨PATHä¸­ä¼˜å…ˆäºç³»ç»Ÿffmpeg (`/usr/bin/ffmpeg`)
- **è§£å†³æ–¹æ¡ˆ**:
  1. åœ¨Dockerfileä¸­å®‰è£…ç³»ç»Ÿffmpeg: `apt-get install ffmpeg`
  2. åœ¨`main.py`ä¸­æ˜¾å¼ä½¿ç”¨`/usr/bin/ffmpeg`è€Œé`ffmpeg`å‘½ä»¤

## ä¿®å¤å†…å®¹

### 1. Dockerfileæ›´æ”¹
```dockerfile
# æ·»åŠ ç³»ç»Ÿffmpegå®‰è£…
RUN apt-get install -y git gcc mono-mcs ffmpeg
```

### 2. src/subsai/main.pyæ›´æ”¹ (ç¬¬456è¡Œ)
```python
# åŸä»£ç ä½¿ç”¨condaçš„ffmpeg (æ— libx264æ”¯æŒ)
ffmpeg_cmd = ['ffmpeg', '-i', media_file, ...]

# ä¿®å¤åä½¿ç”¨ç³»ç»Ÿffmpeg (æœ‰libx264å’Œsubtitlesæ»¤é•œ)
ffmpeg_cmd = ['/usr/bin/ffmpeg', '-i', media_file, ...]
```

## æµ‹è¯•è¿‡ç¨‹

### æµ‹è¯•ç¯å¢ƒ
- **Dockerå®¹å™¨**: subsai-webui
- **æµ‹è¯•è§†é¢‘**: WanVideo2_1_InfiniteTalk_00195-audio.mp4 (5.5MB)
- **æµ‹è¯•è„šæœ¬**: test_final.py (è‡ªåŠ¨åŒ–ç«¯åˆ°ç«¯æµ‹è¯•)

### æµ‹è¯•æ­¥éª¤
1. âœ… å®Œå…¨é‡å»ºDockeré•œåƒ (`--no-cache`)
2. âœ… å¤åˆ¶æµ‹è¯•è§†é¢‘åˆ°å®¹å™¨ (`/tmp/test_video.mp4`)
3. âœ… éªŒè¯ç³»ç»Ÿffmpegå®‰è£…å’ŒåŠŸèƒ½
4. âœ… è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
5. âœ… éªŒè¯ç”Ÿæˆçš„å¡æ‹‰OKè§†é¢‘

### æµ‹è¯•ç»“æœ

#### è‡ªåŠ¨åŒ–æµ‹è¯•è¾“å‡º
```
ğŸ¤ æœ€ç»ˆå¡æ‹‰OKç”Ÿæˆæµ‹è¯•
ğŸ“¹ æµ‹è¯•è§†é¢‘: /tmp/test_video.mp4

1ï¸âƒ£ è½¬å½•ä¸­...
   âœ… ç”Ÿæˆ 4 ä¸ªå­—å¹•

2ï¸âƒ£ ç”Ÿæˆå¡æ‹‰OKå­—å¹•...
   âœ… ç”Ÿæˆ 5 ä¸ªå¡æ‹‰OKäº‹ä»¶
   ğŸ” Styles: ['Default']
      Default: <class 'pysubs2.ssastyle.SSAStyle'>  # âœ… æ­£ç¡®çš„å¯¹è±¡ç±»å‹

3ï¸âƒ£ çƒ§å½•å¡æ‹‰OKå­—å¹•åˆ°è§†é¢‘...
   ğŸ¬ æ‰§è¡Œffmpegå‘½ä»¤: /usr/bin/ffmpeg -i /tmp/test_video.mp4
      -vf subtitles=/tmp/tmp2i9xrmo8.ass
      -c:v libx264
      -crf 23
      -preset medium
      -c:a copy
      -y /tmp/final_test_karaoke.mp4
   âœ… ffmpegæ‰§è¡ŒæˆåŠŸ

âœ… æˆåŠŸï¼è¾“å‡º: /tmp/final_test_karaoke.mp4
   æ–‡ä»¶å¤§å°: 2.61 MB
```

#### è§†é¢‘ä¿¡æ¯éªŒè¯
```json
{
  "streams": [
    {
      "codec_name": "h264",
      "codec_type": "video",
      "width": 480,
      "height": 832,
      "duration": "17.880000",
      "bit_rate": "1078119"
    },
    {
      "codec_name": "aac",
      "codec_type": "audio"
    }
  ]
}
```

#### ASSå­—å¹•å†…å®¹éªŒè¯
ç”Ÿæˆçš„ASSæ–‡ä»¶åŒ…å«æ­£ç¡®çš„å¡æ‹‰OKæ ‡ç­¾ï¼š
```
[V4+ Styles]
Style: Default,Microsoft YaHei,48,16777215,65535,0,2147483648,-1,0,0,0,100.0,100.0,0.0,0.0,1,3.0,2.0,2,30,30,120,1

[Events]
Dialogue: 0,0:00:00.00,0:00:05.00,Default,,0,0,0,,\k166Hello\k166world\k166test
```
âœ… `\k`æ ‡ç­¾æ­£ç¡®ç”Ÿæˆ (å¡æ‹‰OKæ•ˆæœæ ‡è®°)

#### è§†è§‰éªŒè¯
ä»è¾“å‡ºè§†é¢‘æˆªå–çš„å¸§æ˜¾ç¤ºï¼š
- âœ… å­—å¹•æˆåŠŸçƒ§å½•åˆ°è§†é¢‘ç”»é¢
- âœ… ç™½è‰²å­—ä½“ï¼Œé»‘è‰²æè¾¹
- âœ… ä½äºç”»é¢ä¸‹æ–¹ä¸­å¤®ä½ç½®
- âœ… æ¸…æ™°å¯è¯»

![éªŒè¯æˆªå›¾](karaoke_frame.jpg)

## æµ‹è¯•ç»“è®º

### âœ… æµ‹è¯•é€šè¿‡
å¡æ‹‰OKå­—å¹•ç”Ÿæˆå’Œçƒ§å½•åŠŸèƒ½**å®Œå…¨æ­£å¸¸å·¥ä½œ**ï¼š

1. âœ… ASSæ ¼å¼çš„`\k`å¡æ‹‰OKæ ‡ç­¾æ­£ç¡®ç”Ÿæˆ
2. âœ… `pysubs2.SSAStyle`å¯¹è±¡æ­£ç¡®åˆ›å»ºå’Œä½¿ç”¨
3. âœ… ç³»ç»ŸffmpegæˆåŠŸçƒ§å½•ASSå­—å¹•ï¿½ï¿½è§†é¢‘
4. âœ… å­—å¹•åœ¨è§†é¢‘ä¸­æ¸…æ™°å¯è§ï¼Œæ ¼å¼æ­£ç¡®

### æŠ€æœ¯è¦ç‚¹
- ä½¿ç”¨`/usr/bin/ffmpeg`ç¡®ä¿è®¿é—®å®Œæ•´åŠŸèƒ½çš„ç³»ç»Ÿffmpeg
- Dockeré•œåƒæ„å»ºä½¿ç”¨`--no-cache`é¿å…Pythonç¼“å­˜é—®é¢˜
- ASSå­—å¹•æ ¼å¼ä¿ç•™äº†å¡æ‹‰OKæ•ˆæœæ ‡ç­¾ (`\k`)
- ä½¿ç”¨`subtitles`æ»¤é•œå®ç°ç¡¬ç¼–ç å­—å¹•çƒ§å½•

## æ–‡ä»¶æ¸…å•
- `test_final.py` - è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
- `final_test_karaoke.mp4` - æµ‹è¯•è¾“å‡ºè§†é¢‘ (2.7MB)
- `karaoke_frame.jpg` - éªŒè¯æˆªå›¾
- `Dockerfile` - æ›´æ–°çš„Dockeré…ç½®
- `src/subsai/main.py` - ä¿®å¤çš„ä¸»ä»£ç æ–‡ä»¶

## åç»­å»ºè®®
1. ä¿æŒä½¿ç”¨ç³»ç»Ÿffmpegè·¯å¾„ (`/usr/bin/ffmpeg`)
2. æ¯æ¬¡æ›´æ–°ä»£ç åä½¿ç”¨`--no-cache`é‡å»ºDockeré•œåƒ
3. åœ¨WebUIä¸­æµ‹è¯•"Generate Karaoke Video"åŠŸèƒ½ç¡®ä¿ç«¯åˆ°ç«¯æµç¨‹æ­£å¸¸
